db:
    image: silintl/mariadb:latest
    environment:
        MYSQL_ROOT_PASSWORD: r00tp@ss!
        MYSQL_DATABASE: test
        MYSQL_USER: idpmgmt
        MYSQL_PASSWORD: idpmgmt

zxcvbn:
    image: wcjr/zxcvbn-api:1.1.0
    ports:
        - "3000"

api:
    build:
        image: silintl/idp-pw-api
        dockerfile: ./Dockerfile
    cached: true
    depends_on:
        - db
        - zxcvbn
        - broker
        - ldapload
    volumes:
        - ./application/common/config/test.php:/data/common/config/local.php
    environment:
        MYSQL_HOST: db
        MYSQL_DATABASE: test
        MYSQL_USER: idpmgmt
        MYSQL_PASSWORD: idpmgmt
        ALERTS_EMAIL_ENABLED: false
        ALERTS_EMAIL: alerts@nowhere.com
        ID_BROKER_baseUrl: http://broker
        ID_BROKER_accessToken: abc123
        ID_BROKER_assertValidBrokerIp: false
        ID_BROKER_validIpRanges: 127.0.0.1/32,192.168.65.1/32
        TEST_GOOGLE_PWSTORE_CONFIG_applicationName: idpGooglePwStoreTestsByCI
        RECAPTCHA_REQUIRED: false
        EMAIL_SERVICE_accessToken: fake
        EMAIL_SERVICE_assertValidIp: "false"
        EMAIL_SERVICE_baseUrl: fake
        EMAIL_SERVICE_validIpRanges: 10.0.0.0/128
        EMAILER_CLASS: tests\mock\emailer\FakeEmailer
        AUTH_CLASS: tests\mock\auth\Component
        PASSWORDSTORE_CLASS: tests\mock\passwordstore\Component
    encrypted_env_file: codeship.env.encrypted
    working_dir: /data
    command: /data/run-tests.sh

brokerDb:
    image: silintl/mariadb:latest
    ports:
    - "3306"
    environment:
        MYSQL_ROOT_PASSWORD: r00tp@ss!
        MYSQL_HOST: db
        MYSQL_DATABASE: app
        MYSQL_USER: user
        MYSQL_PASSWORD: pass

broker:
    image: silintl/idp-id-broker:develop-4.0
    depends_on:
    - brokerDb
    volumes:
    - ./run-broker.sh:/data/run-broker.sh
    working_dir: /data
    environment:
        EMAIL_SERVICE_accessToken: fake
        EMAIL_SERVICE_assertValidIp: "false"
        EMAIL_SERVICE_baseUrl: fake
        EMAIL_SERVICE_validIpRanges: 10.0.0.0/128
        IDP_NAME: idp1
        MYSQL_HOST: brokerDb
        MYSQL_DATABASE: app
        MYSQL_USER: user
        MYSQL_PASSWORD: pass
        MYSQL_ROOT_PASSWORD: dummy-root-password
        API_ACCESS_KEYS: abc123
        HELP_CENTER_URL: https://example.com/#/help
        PASSWORD_FORGOT_URL: https://example.com/#/forgot
        PASSWORD_PROFILE_URL: https://example.com/#/profile
        SUPPORT_EMAIL: support@example.com
        EMAIL_SIGNATURE: Dummy Signature for Tests
        RESET_lifetimeSeconds: 3600
        RESET_codeLength: 6
        EMAILER_CLASS: \Sil\SilIdBroker\Behat\Context\fakes\FakeEmailer
    command: whenavail brokerDb 3306 60 ./run-broker.sh

ldap:
    build: ./dockerbuild/ldap
    container_name: ldap
    ports:
    - "389"
    working_dir: /data
    environment:
        DEBUG_LEVEL: 320

ldapload:
    build: ./dockerbuild/ldap
    container_name: ldapload
    depends_on:
    - ldap
    working_dir: /data
    command: ./load_ldap.sh
